generator client {
	provider = "prisma-client-js"
}

datasource db {
	provider = "postgresql"
	url      = env("DATABASE_URL")
}

enum MaintenanceStatus {
	OPEN
	PENDING
	IN_TRIAGE
	SCHEDULED
	IN_PROGRESS
	RESOLVED
	CANCELLED
}

enum Priority {
	CRITICAL
	HIGH
	NORMAL
	LOW
}

enum UtilityType {
	INTERNET
	WATER_GAS
	HYDRO
}

model Tenant {
	id          String               @id @default(cuid())
	name        String
	phone       String?              @unique
	email       String?              @unique
	autoReplyEnabled Boolean          @default(true)
	units       UnitTenant[]
	requests    MaintenanceRequest[]
	utilityBills UtilityBill[]
	createdAt   DateTime             @default(now())
	updatedAt   DateTime             @updatedAt
}

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Unit {
	id            String               @id @default(cuid())
	label         String
	address       String
	tenants       UnitTenant[]
	requests      MaintenanceRequest[]
	utilityBills  UtilityBill[]
	utilityCredentials UtilityCredential[]
	createdAt     DateTime             @default(now())
	updatedAt     DateTime             @updatedAt
}

model UnitTenant {
	id        String   @id @default(cuid())
	tenant    Tenant   @relation(fields: [tenantId], references: [id])
	tenantId  String
	unit      Unit     @relation(fields: [unitId], references: [id])
	unitId    String
	startDate DateTime @default(now())
	endDate   DateTime?
}

model MaintenanceRequest {
	id             String            @id @default(cuid())
	tenant         Tenant?           @relation(fields: [tenantId], references: [id])
	tenantId       String?
	unit           Unit?             @relation(fields: [unitId], references: [id])
	unitId         String?
	message        String
	status         MaintenanceStatus @default(OPEN)
	statusChangedAt DateTime          @default(now())
	priority       Priority          @default(NORMAL)
	category       String?
	triageJson     Json?
	aiDraft        Json?
	autopilotEnabled Boolean          @default(false)
	autopilotStatus String?
	autopilotLog  Json?
	chatLog        Json?
	landlordReply  String?
	utilityAnomaly Boolean           @default(false)
	utilityNotes   String?
	mcpTaskId      String?
	createdAt      DateTime          @default(now())
	updatedAt      DateTime          @updatedAt
	utilityBills   UtilityBill[]

	@@index([status])
}

model UtilityBill {
	id               String       @id @default(cuid())
	utilityType      UtilityType
	amountCents      Int
	currency         String        @default("CAD")
	usageAmount      Float?
	usageUnit        String?
	billingPeriodStart DateTime
	billingPeriodEnd DateTime
	statementUrl     String?
	portalUsername   String?
	anomalyFlag      Boolean      @default(false)
	anomalyNotes     String?
	rawData          Json?
	tenant           Tenant?      @relation(fields: [tenantId], references: [id])
	tenantId         String?
	unit             Unit?        @relation(fields: [unitId], references: [id])
	unitId           String?
	maintenance      MaintenanceRequest? @relation(fields: [maintenanceId], references: [id])
	maintenanceId    String?
	createdAt        DateTime     @default(now())
	updatedAt        DateTime     @updatedAt
}

model Contractor {
	id        String   @id @default(cuid())
	name      String
	phone     String   @unique
	email     String?
	role      String?
	createdAt DateTime @default(now())
	updatedAt DateTime @updatedAt
}

model UtilityCredential {
	id          String      @id @default(cuid())
	unit        Unit        @relation(fields: [unitId], references: [id])
	unitId      String
	utilityType UtilityType
	username    String?
	password    String?
	notes       String?
	createdAt   DateTime    @default(now())
	updatedAt   DateTime    @updatedAt
}
